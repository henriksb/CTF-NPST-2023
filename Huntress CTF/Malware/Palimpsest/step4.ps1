# Define the file type using the System.IO.File class
$FileType = [System.IO.File]

# Define the range of InstanceIDs to filter
$InstanceIDs = 40000..65000

# Path to the uploaded .evtx log file
$LogFilePath = "Application.evtx"  # Adjust this as needed

# Open (or create) the flag.mp4 file in the AppData directory for writing
$FileStream = $FileType::OpenWrite("flag.mp4")

# Use Get-WinEvent to read from the .evtx file and filter by source and InstanceID range
Get-WinEvent -Path $LogFilePath |
    Where-Object { $_.ProviderName -eq "mslnstaller" -and $InstanceIDs -contains $_.Id } |  
    Sort-Object Id, Index -Descending |    # Sort in descending order by Id and Index
    ForEach-Object {
        $Data = $_.Properties | ForEach-Object { $_.Value }                                # Extract the Data property values
        $Bytes = [System.Text.Encoding]::UTF8.GetBytes(($Data -join " "))                  # Convert data to bytes
        $FileStream.Write($Bytes, 0, $Bytes.Length)                                        # Write the data to the flag.mp4 file
    }

# Close the file stream to ensure all data is written and resources are freed
$FileStream.Close()
